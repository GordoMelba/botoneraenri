<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cat√°logo B2B ‚Üí Pedido por WhatsApp</title>
  <style>
    :root{
      --bg:#0b0c10;
      --card:#12141b;
      --muted:#a9b0c0;
      --text:#eef1f7;
      --line:rgba(255,255,255,.08);
      --accent:#ffd400;
      --good:#2ee59d;
      --bad:#ff5c7a;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:16px;
      --radius2:22px;
      --max:1180px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue";
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--font);
      background: radial-gradient(1000px 600px at 20% -10%, rgba(255,212,0,.15), transparent 60%),
                  radial-gradient(900px 700px at 90% 10%, rgba(46,229,157,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    a{ color:inherit; text-decoration:none; }
    .wrap{ max-width:var(--max); margin:0 auto; padding:24px; }
    header{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      margin-bottom:18px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .logo{
      width:44px; height:44px; border-radius:14px;
      background: linear-gradient(135deg, rgba(255,212,0,.95), rgba(255,212,0,.35));
      box-shadow: var(--shadow);
      display:grid; place-items:center;
      color:#111;
      font-weight:800;
      letter-spacing:-0.5px;
    }
    .title h1{
      font-size:18px; margin:0; line-height:1.15;
      letter-spacing:-0.2px;
    }
    .title p{
      margin:2px 0 0; color:var(--muted); font-size:13px;
    }

    .top-actions{
      display:flex; gap:10px; align-items:center;
    }

    .pill{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      padding:10px 12px;
      border-radius:999px;
      display:flex; gap:10px; align-items:center;
      box-shadow: 0 8px 18px rgba(0,0,0,.18);
    }
    .pill input{
      background:transparent; border:0; outline:none; color:var(--text);
      width:240px; font-size:14px;
    }

    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
      user-select:none;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn:hover{ background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.14); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: rgba(255,212,0,.16);
      border-color: rgba(255,212,0,.35);
    }
    .btn.primary:hover{
      background: rgba(255,212,0,.22);
      border-color: rgba(255,212,0,.55);
    }
    .btn.good{
      background: rgba(46,229,157,.14);
      border-color: rgba(46,229,157,.35);
    }
    .btn.good:hover{ background: rgba(46,229,157,.20); border-color: rgba(46,229,157,.55); }
    .btn.danger{
      background: rgba(255,92,122,.12);
      border-color: rgba(255,92,122,.32);
    }
    .btn.danger:hover{ background: rgba(255,92,122,.18); border-color: rgba(255,92,122,.5); }

    .grid{
      display:grid;
      grid-template-columns: 1.5fr .9fr;
      gap:16px;
      align-items:start;
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .pill input{ width: 160px; }
    }

    .panel{
      background: rgba(255,255,255,.03);
      border:1px solid var(--line);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .panel-header{
      padding:14px 14px;
      border-bottom:1px solid var(--line);
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .panel-header h2{
      margin:0; font-size:14px; letter-spacing:-0.2px;
    }
    .panel-header .meta{
      color:var(--muted); font-size:12px;
    }

    .filters{
      padding:12px 14px 14px;
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
      border-bottom:1px solid var(--line);
    }
    select, input[type="number"], input[type="text"]{
      background: rgba(255,255,255,.03);
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 10px;
      color:var(--text);
      outline:none;
      font-size:14px;
    }
    select option{ background:#0f1117; }

    .catalog{
      padding:14px;
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:12px;
    }
    @media (max-width: 680px){
      .catalog{ grid-template-columns: 1fr; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      overflow:hidden;
      display:flex; flex-direction:column;
      min-height: 290px;
    }
    .card .img{
      height:140px;
      background: #0f1117;
      position:relative;
      overflow:hidden;
    }
    .card img{
      width:100%; height:100%; object-fit:cover;
      filter: saturate(1.1) contrast(1.02);
      transform: scale(1.02);
    }
    .tag{
      position:absolute;
      top:10px; left:10px;
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.9);
      padding:6px 9px;
      border-radius:999px;
      font-size:12px;
      backdrop-filter: blur(6px);
    }
    .card .body{
      padding:12px;
      display:flex; flex-direction:column;
      gap:10px;
      flex:1;
    }
    .name{
      font-weight:700; letter-spacing:-0.2px;
      line-height:1.2;
    }
    .code{
      color:var(--muted); font-size:12px;
      margin-top:-6px;
    }
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .row-3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }
    .hint{
      color:var(--muted); font-size:12px; line-height:1.35;
    }
    .mini{
      font-size:12px; color:var(--muted);
    }
    .addbar{
      margin-top:auto;
      display:flex; gap:10px; align-items:center;
      justify-content:space-between;
    }
    .qty{
      display:flex; gap:8px; align-items:center;
    }
    .qty input{
      width:100px;
    }

    /* Cart */
    .cart-body{
      padding:14px;
      display:flex; flex-direction:column; gap:12px;
    }
    .cart-list{
      display:flex; flex-direction:column; gap:10px;
      max-height: 360px;
      overflow:auto;
      padding-right:4px;
    }
    .cart-item{
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      border-radius:14px;
      padding:10px;
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
    }
    .cart-item .left{
      display:flex; flex-direction:column; gap:4px;
      min-width: 0;
    }
    .cart-item .left .t{
      font-weight:700; font-size:13px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .cart-item .left .s{
      color:var(--muted); font-size:12px;
    }
    .cart-item .right{
      display:flex; gap:8px; align-items:center;
      flex-shrink:0;
    }
    .cart-item .right input{
      width:86px;
      padding:8px 9px;
      border-radius:12px;
      font-size:13px;
    }
    .divider{
      height:1px; background: var(--line); margin:4px 0;
    }

    textarea{
      width:100%;
      min-height: 190px;
      resize: vertical;
      border-radius:14px;
      padding:12px;
      background: rgba(0,0,0,.25);
      border:1px solid var(--line);
      color:var(--text);
      outline:none;
      line-height:1.4;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12.5px;
    }

    .footer-actions{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
      justify-content:space-between;
    }
    .small{
      font-size:12px; color:var(--muted); line-height:1.35;
    }

    .toast{
      position: fixed;
      bottom: 16px; left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,.75);
      border:1px solid rgba(255,255,255,.14);
      padding:10px 12px;
      border-radius:999px;
      color: rgba(255,255,255,.92);
      font-size:13px;
      box-shadow: var(--shadow);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(-4px);
    }

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size:12px;
      padding:2px 7px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.9);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">BE</div>
        <div class="title">
          <h1>Cat√°logo B2B ‚Üí Pedido por WhatsApp</h1>
          <p>Seleccion√° productos, variantes y cantidades. Gener√° el texto y mandalo por WhatsApp.</p>
        </div>
      </div>

      <div class="top-actions">
        <div class="pill" title="Buscar producto (nombre o c√≥digo)">
          üîé <input id="search" type="text" placeholder="Buscar‚Ä¶ (ej: bronce 4.5 / B45F)" />
          <span class="kbd">Ctrl</span><span class="kbd">K</span>
        </div>
        <button class="btn primary" id="btnConfig" title="Configurar tu WhatsApp">‚öôÔ∏è WhatsApp</button>
      </div>
    </header>

    <div class="grid">
      <!-- Left: Catalog -->
      <section class="panel">
        <div class="panel-header">
          <h2>Cat√°logo</h2>
          <div class="meta"><span id="countShown">0</span> productos mostrados</div>
        </div>

        <div class="filters">
          <select id="category">
            <option value="__all__">Todas las categor√≠as</option>
          </select>

          <select id="sort">
            <option value="name_asc">Orden: Nombre A‚ÜíZ</option>
            <option value="name_desc">Orden: Nombre Z‚ÜíA</option>
          </select>

          <button class="btn" id="btnReset">üßπ Limpiar filtros</button>
          <div class="mini">Tip: cuando est√© listo, reemplaz√° fotos y productos en el JSON del script.</div>
        </div>

        <div class="catalog" id="catalog"></div>
      </section>

      <!-- Right: Cart + Generated text -->
      <aside class="panel">
        <div class="panel-header">
          <h2>Pedido</h2>
          <div class="meta"><span id="cartCount">0</span> √≠tems</div>
        </div>

        <div class="cart-body">
          <div class="small">
            Este ‚Äúpedido‚Äù no cobra ni factura. Solo arma el texto para WhatsApp.
          </div>

          <div class="cart-list" id="cart"></div>

          <div class="divider"></div>

          <label class="small" for="notes"><b>Observaciones</b> (opcional)</label>
          <input id="notes" type="text" placeholder="Ej: retirar en Flores / entregar ma√±ana / etc." />

          <label class="small" for="orderText"><b>Texto para WhatsApp</b></label>
          <textarea id="orderText" readonly></textarea>

          <div class="footer-actions">
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn good" id="btnCopy">üìã Copiar texto</button>
              <a class="btn primary" id="btnWhatsApp" href="#" target="_blank" rel="noopener">üí¨ Abrir WhatsApp</a>
            </div>
            <button class="btn danger" id="btnClearCart">üóëÔ∏è Vaciar pedido</button>
          </div>

          <div class="small">
            Si WhatsApp Web no abre con el texto, us√° <b>Copiar</b> y peg√° en el chat.
          </div>
        </div>
      </aside>
    </div>
  </div>

  <div class="toast" id="toast">Listo</div>

  <script>
    /************************************************************
     * 1) EDIT√Å AC√Å TU CAT√ÅLOGO (sin programar ‚Äúreal‚Äù):
     *    - name: nombre oficial del producto
     *    - code: tu c√≥digo interno (opcional)
     *    - category: categor√≠a
     *    - image: link a la imagen (pod√©s subirlas a Drive con link p√∫blico,
     *             o a un hosting/cdn. Para probar: placeholders.)
     *    - variants: colores y medidas disponibles
     *    - minQty: cantidad m√≠nima sugerida (ej: 50)
     *    - unit: unidad (unidades/metros/etc.)
     ************************************************************/
    const CATALOG = [
      {
        id: "b45f",
        name: "Cierre Bronce Cadena 4.5",
        code: "C.B45F",
        category: "Cierres met√°licos",
        image: "https://images.unsplash.com/photo-1520975693411-6f9d96ed1d48?auto=format&fit=crop&w=1400&q=70",
        variants: {
          colors: ["Azul", "Negro", "Crudo", "Verde botella"],
          sizes: ["10 cm", "12 cm", "14 cm", "16 cm"]
        },
        minQty: 50,
        unit: "u"
      },
      {
        id: "p15f",
        name: "Cierre Pl√°stico P15F (Fijo)",
        code: "CB.P15F",
        category: "Cierres pl√°sticos",
        image: "https://images.unsplash.com/photo-1520975693411-6f9d96ed1d48?auto=format&fit=crop&w=1400&q=70",
        variants: {
          colors: ["Negro", "Blanco", "Azul marino", "Gris topo"],
          sizes: ["40 cm", "50 cm", "60 cm", "70 cm", "80 cm"]
        },
        minQty: 50,
        unit: "u"
      },
      {
        id: "p15s",
        name: "Cierre Pl√°stico P15S (Separable)",
        code: "CB.P15S",
        category: "Cierres pl√°sticos",
        image: "https://images.unsplash.com/photo-1587731556938-38755b4803a6?auto=format&fit=crop&w=1400&q=70",
        variants: {
          colors: ["Negro", "Blanco", "Azul Francia", "Rojo"],
          sizes: ["50 cm", "60 cm", "70 cm", "80 cm"]
        },
        minQty: 50,
        unit: "u"
      },
      {
        id: "invisible",
        name: "Cierre Invisible",
        code: "C.AI",
        category: "Cierres invisibles",
        image: "https://images.unsplash.com/photo-1611095973510-9b7e3c1c4f86?auto=format&fit=crop&w=1400&q=70",
        variants: {
          colors: ["Negro", "Azul", "Beige", "Gris plata"],
          sizes: ["10 cm", "12 cm", "14 cm", "16 cm", "18 cm"]
        },
        minQty: 50,
        unit: "u"
      },
      {
        id: "cinta",
        name: "Cinta Hilera 100 m",
        code: "CI.100M",
        category: "Cintas",
        image: "https://images.unsplash.com/photo-1600765962361-9035dbfd33d1?auto=format&fit=crop&w=1400&q=70",
        variants: {
          colors: ["Negro", "Blanco", "Azul marino"],
          sizes: ["100 m"]
        },
        minQty: 1,
        unit: "rollo"
      },
      {
        id: "ojalillos",
        name: "Ojalillos x1000",
        code: "OJ.1000",
        category: "Av√≠os",
        image: "https://images.unsplash.com/photo-1520975939898-6d2c6a622a80?auto=format&fit=crop&w=1400&q=70",
        variants: {
          colors: ["N√≠quel", "Dorado", "Negro"],
          sizes: ["4 mm", "5 mm", "6 mm"]
        },
        minQty: 1,
        unit: "bolsa"
      }
    ];

    /************************************************************
     * 2) Configuraci√≥n WhatsApp (tu n√∫mero)
     *    - guardamos en localStorage para no pedirlo siempre
     *    - formato recomendado Argentina: 549 + area + n√∫mero (sin 0 ni 15)
     *      ejemplo CABA: 54911XXXXXXXX
     ************************************************************/
    const LS_WA = "b2b_catalog_whatsapp_number";
    let whatsappNumber = localStorage.getItem(LS_WA) || ""; // e.g. 54911XXXXXXXX

    /************************************************************
     * Estado del carrito
     ************************************************************/
    // cart items: { key, productId, name, code, category, color, size, qty, minQty, unit }
    let cart = [];

    // Helpers
    const $ = (sel) => document.querySelector(sel);

    function toast(msg){
      const t = $("#toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(()=> t.classList.remove("show"), 1400);
    }

    function normalize(s){
      return String(s || "").toLowerCase().trim();
    }

    function unique(arr){
      return [...new Set(arr)];
    }

    function formatQty(qty, unit){
      // "u" stays "u", else show unit word
      if(unit === "u") return `${qty} u`;
      return `${qty} ${unit}`;
    }

    function promptWhatsapp(){
      const current = whatsappNumber ? `\nActual: ${whatsappNumber}` : "";
      const msg =
        "Ingres√° tu n√∫mero de WhatsApp para armar el link.\n" +
        "Formato recomendado Argentina: 549 + √°rea + n√∫mero (sin 0 ni 15)\n" +
        "Ejemplo CABA: 54911XXXXXXXX" + current;
      const input = window.prompt(msg, whatsappNumber || "54911");
      if(input === null) return; // cancel
      whatsappNumber = input.replace(/\D/g, ""); // digits only
      localStorage.setItem(LS_WA, whatsappNumber);
      toast("WhatsApp configurado");
      updateWhatsAppLink();
    }

    function buildCategoryOptions(){
      const cats = unique(CATALOG.map(p => p.category)).sort((a,b)=> a.localeCompare(b,"es"));
      const sel = $("#category");
      // reset (keep first)
      sel.innerHTML = `<option value="__all__">Todas las categor√≠as</option>` +
        cats.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function renderCatalog(){
      const q = normalize($("#search").value);
      const cat = $("#category").value;
      const sort = $("#sort").value;

      let items = [...CATALOG];

      if(cat !== "__all__"){
        items = items.filter(p => p.category === cat);
      }

      if(q){
        items = items.filter(p => {
          const hay = normalize(`${p.name} ${p.code} ${p.category} ${p.variants.colors.join(" ")} ${p.variants.sizes.join(" ")}`);
          return hay.includes(q);
        });
      }

      items.sort((a,b)=>{
        if(sort === "name_desc") return b.name.localeCompare(a.name,"es");
        return a.name.localeCompare(b.name,"es");
      });

      $("#countShown").textContent = items.length;

      const html = items.map(p => cardHtml(p)).join("");
      $("#catalog").innerHTML = html;

      // attach handlers for each card
      items.forEach(p => attachCardHandlers(p.id, p.minQty));
    }

    function cardHtml(p){
      const colorOptions = p.variants.colors.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
      const sizeOptions = p.variants.sizes.map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join("");

      return `
        <div class="card" data-id="${escapeHtml(p.id)}">
          <div class="img">
            <img alt="${escapeHtml(p.name)}" src="${escapeHtml(p.image)}" loading="lazy" />
            <div class="tag">${escapeHtml(p.category)}</div>
          </div>
          <div class="body">
            <div>
              <div class="name">${escapeHtml(p.name)}</div>
              <div class="code">${escapeHtml(p.code || "")}</div>
            </div>

            <div class="row">
              <div>
                <div class="mini">Color</div>
                <select id="color-${escapeHtml(p.id)}">${colorOptions}</select>
              </div>
              <div>
                <div class="mini">Medida</div>
                <select id="size-${escapeHtml(p.id)}">${sizeOptions}</select>
              </div>
            </div>

            <div class="addbar">
              <div class="qty">
                <div>
                  <div class="mini">Cantidad</div>
                  <input id="qty-${escapeHtml(p.id)}" type="number" min="${p.minQty}" step="1" value="${p.minQty}" />
                </div>
                <div class="hint">M√≠nimo: <b>${p.minQty}</b> ${escapeHtml(p.unit)}</div>
              </div>
              <button class="btn good" id="add-${escapeHtml(p.id)}">‚ûï Agregar</button>
            </div>
          </div>
        </div>
      `;
    }

    function attachCardHandlers(productId, minQty){
      const addBtn = document.getElementById(`add-${productId}`);
      if(!addBtn) return;

      addBtn.addEventListener("click", () => {
        const color = document.getElementById(`color-${productId}`).value;
        const size  = document.getElementById(`size-${productId}`).value;
        const qtyEl = document.getElementById(`qty-${productId}`);
        let qty = Number(qtyEl.value || 0);

        if(!Number.isFinite(qty) || qty <= 0){
          toast("Cantidad inv√°lida");
          qtyEl.value = minQty;
          return;
        }
        if(qty < minQty){
          toast(`Cantidad m√≠nima: ${minQty}`);
          qty = minQty;
          qtyEl.value = minQty;
        }

        const p = CATALOG.find(x => x.id === productId);
        if(!p) return;

        // Unique key by product+variant
        const key = `${p.id}__${color}__${size}`;
        const existing = cart.find(i => i.key === key);
        if(existing){
          existing.qty += qty; // accumulate
        }else{
          cart.push({
            key,
            productId: p.id,
            name: p.name,
            code: p.code || "",
            category: p.category,
            color,
            size,
            qty,
            minQty: p.minQty,
            unit: p.unit || "u"
          });
        }
        toast("Agregado al pedido");
        renderCart();
        buildOrderText();
      });
    }

    function renderCart(){
      $("#cartCount").textContent = cart.length;

      if(cart.length === 0){
        $("#cart").innerHTML = `
          <div class="small" style="padding:10px; border:1px dashed rgba(255,255,255,.14); border-radius:14px;">
            Todav√≠a no agregaste √≠tems. Eleg√≠ producto, color, medida y cantidad en el cat√°logo.
          </div>
        `;
        updateWhatsAppLink();
        return;
      }

      // Sort cart by category then name
      const sorted = [...cart].sort((a,b)=>{
        const c = a.category.localeCompare(b.category,"es");
        if(c !== 0) return c;
        const n = a.name.localeCompare(b.name,"es");
        if(n !== 0) return n;
        const v = `${a.color} ${a.size}`.localeCompare(`${b.color} ${b.size}`,"es");
        return v;
      });

      $("#cart").innerHTML = sorted.map(item => `
        <div class="cart-item" data-key="${escapeHtml(item.key)}">
          <div class="left">
            <div class="t">${escapeHtml(item.name)}</div>
            <div class="s">${escapeHtml(item.code)} ¬∑ ${escapeHtml(item.color)} ¬∑ ${escapeHtml(item.size)}</div>
          </div>
          <div class="right">
            <input type="number" min="${item.minQty}" step="1" value="${item.qty}" title="Cantidad" />
            <button class="btn danger" title="Eliminar">‚úñ</button>
          </div>
        </div>
      `).join("");

      // handlers
      document.querySelectorAll(".cart-item").forEach(el => {
        const key = el.getAttribute("data-key");
        const qtyInput = el.querySelector("input");
        const delBtn = el.querySelector("button");

        qtyInput.addEventListener("change", () => {
          const item = cart.find(i => i.key === key);
          if(!item) return;
          let q = Number(qtyInput.value || 0);
          if(!Number.isFinite(q) || q <= 0) q = item.minQty;
          if(q < item.minQty) q = item.minQty;
          item.qty = q;
          qtyInput.value = q;
          buildOrderText();
        });

        delBtn.addEventListener("click", () => {
          cart = cart.filter(i => i.key !== key);
          renderCart();
          buildOrderText();
        });
      });

      updateWhatsAppLink();
    }

    function buildOrderText(){
      const notes = ($("#notes").value || "").trim();

      if(cart.length === 0){
        $("#orderText").value = "PEDIDO\n\n(Agregar √≠tems desde el cat√°logo)";
        updateWhatsAppLink();
        return;
      }

      // group by category, then by product
      const byCat = {};
      for(const item of cart){
        if(!byCat[item.category]) byCat[item.category] = [];
        byCat[item.category].push(item);
      }

      let lines = [];
      lines.push("PEDIDO");
      lines.push("");

      const cats = Object.keys(byCat).sort((a,b)=> a.localeCompare(b,"es"));
      for(const cat of cats){
        lines.push(cat.toUpperCase());
        // group by product name
        const items = byCat[cat].sort((a,b)=>{
          const n = a.name.localeCompare(b.name,"es");
          if(n !== 0) return n;
          return `${a.color} ${a.size}`.localeCompare(`${b.color} ${b.size}`,"es");
        });

        let currentName = null;
        for(const it of items){
          if(it.name !== currentName){
            currentName = it.name;
            lines.push(`- ${it.name}${it.code ? " ("+it.code+")" : ""}`);
          }
          lines.push(`  ‚Ä¢ ${it.color} ‚Äì ${it.size} ‚Äì ${formatQty(it.qty, it.unit)}`);
        }
        lines.push("");
      }

      if(notes){
        lines.push("OBSERVACIONES:");
        lines.push(notes);
        lines.push("");
      }

      $("#orderText").value = lines.join("\n");
      updateWhatsAppLink();
    }

    function updateWhatsAppLink(){
      const a = $("#btnWhatsApp");
      const text = $("#orderText").value || "";

      if(!whatsappNumber){
        a.href = "#";
        a.addEventListener("click", (e) => {
          if(!whatsappNumber){
            e.preventDefault();
            promptWhatsapp();
          }
        }, { once:true });
        return;
      }

      const encoded = encodeURIComponent(text);
      a.href = `https://wa.me/${whatsappNumber}?text=${encoded}`;
    }

    async function copyText(){
      const text = $("#orderText").value || "";
      try{
        await navigator.clipboard.writeText(text);
        toast("Texto copiado");
      }catch(e){
        // fallback
        $("#orderText").select();
        document.execCommand("copy");
        toast("Texto copiado");
      }
    }

    function clearCart(){
      cart = [];
      renderCart();
      buildOrderText();
      toast("Pedido vaciado");
    }

    function resetFilters(){
      $("#search").value = "";
      $("#category").value = "__all__";
      $("#sort").value = "name_asc";
      renderCatalog();
      toast("Filtros limpios");
    }

    // Ctrl+K focus search
    window.addEventListener("keydown", (e) => {
      if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "k"){
        e.preventDefault();
        $("#search").focus();
      }
    });

    // Init
    function init(){
      buildCategoryOptions();
      renderCatalog();
      renderCart();
      buildOrderText();
      updateWhatsAppLink();

      $("#search").addEventListener("input", renderCatalog);
      $("#category").addEventListener("change", renderCatalog);
      $("#sort").addEventListener("change", renderCatalog);
      $("#btnReset").addEventListener("click", resetFilters);

      $("#btnConfig").addEventListener("click", promptWhatsapp);
      $("#notes").addEventListener("input", buildOrderText);

      $("#btnCopy").addEventListener("click", copyText);
      $("#btnClearCart").addEventListener("click", clearCart);

      // If no whatsapp configured, set button label hint
      if(!whatsappNumber){
        $("#btnWhatsApp").textContent = "üí¨ Configurar WhatsApp";
      }
    }

    init();
  </script>
</body>
</html>
