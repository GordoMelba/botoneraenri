<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Botonera Enri‚Üí Pedido por WhatsApp</title>
  <style>
    :root{
      --bg:#f5f6fa;
      --panel:#ffffff;
      --line:#e5e7eb;
      --text:#0f172a;
      --muted:#64748b;
      --blue:#1c3f99;
      --blue2:#16357f;
      --green:#16a34a;
      --green2:#12823c;
      --orange:#f97316;
      --shadow: 0 18px 50px rgba(15, 23, 42, .12);
      --radius:14px;
      --radius2:18px;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: Arial, sans-serif; background: var(--bg); color: var(--text); }
    header{ background: var(--blue); color: #fff; padding: 16px 20px; font-weight: 900; font-size: 18px; }

    .container{ display:flex; height: calc(100vh - 56px); }

    .sidebar{
      width: 300px; background: var(--panel); padding: 18px; border-right: 1px solid var(--line);
      overflow:auto;
    }
    .sidebar h3{ margin: 0 0 14px 0; font-size: 18px; letter-spacing: -.2px; }
    .category{
      padding: 12px 12px; cursor:pointer; border-radius: 10px; margin-bottom: 8px;
      font-weight: 900; color: var(--text); background: #f3f5ff; border: 1px solid transparent;
      user-select:none; display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .category:hover{ border-color:#dbe3ff; }
    .category.active{ background: linear-gradient(180deg, var(--blue), var(--blue2)); color:#fff; }
    .category small{ color: var(--muted); font-weight: 900; }
    .category.active small{ color: rgba(255,255,255,.85); }

    .main{ flex:1; padding: 18px; overflow:auto; }
    .mainTop{ display:flex; align-items:flex-end; justify-content:space-between; gap: 12px; margin-bottom: 12px; }
    #categoryTitle{ margin:0; font-size: 28px; letter-spacing: -.4px; }
    .products{ display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 14px; }

    .product{
      background: var(--panel); border-radius: var(--radius2); border: 1px solid var(--line);
      cursor:pointer; overflow:hidden;
      transition: transform .08s ease, box-shadow .2s ease, border-color .2s ease;
    }
    .product:hover{ transform: translateY(-2px); border-color:#dbe3ff; box-shadow: 0 18px 40px rgba(15, 23, 42, .10); }
    .pImg{ height: 160px; background:#eef2ff; position: relative; }
    .pImg img{ width:100%; height:100%; object-fit:cover; display:block; }
    .pBadge{
      position:absolute; top:10px; left:10px; background: rgba(15,23,42,.72);
      color:#fff; font-size:12px; font-weight:900; padding:6px 10px; border-radius: 999px;
    }
    .pBody{ padding: 12px 12px 14px 12px; display:flex; flex-direction:column; gap: 6px; }
    .pTitle{ font-weight: 900; letter-spacing:-.2px; font-size: 15px; }
    .pSub{ color: var(--muted); font-size: 12px; line-height:1.35; }
    .pFoot{ margin-top: 6px; display:flex; align-items:center; justify-content:space-between; gap: 10px; color: var(--muted); font-size: 12px; }
    .pill{
      background:#f1f5f9; border: 1px solid #e2e8f0; padding: 6px 10px;
      border-radius: 999px; font-weight: 900; color:#334155; white-space: nowrap;
    }

    .order{
      width: 460px; background: var(--panel); padding: 18px; border-left: 1px solid var(--line);
      display:flex; flex-direction:column; gap: 12px;
      overflow:auto;
    }
    .order h3{ margin:0; font-size: 20px; letter-spacing:-.2px; }

    .clientBlock{
      display:flex; flex-direction:column; gap: 6px;
      border:1px solid var(--line); border-radius: 12px; padding: 10px; background:#fbfcff;
    }
    .clientLabel{ font-weight:900; font-size: 13px; color:#334155; }
    .clientRow{ display:flex; gap: 10px; align-items:center; }
    .clientRow input{
      width:100%; padding: 12px 12px; border-radius: 12px; border: 1px solid var(--line);
      font-size: 14px; outline:none;
    }
    .req{ color:#ef4444; font-weight: 900; }

    .orderLines{ border:1px solid var(--line); border-radius: 12px; padding: 10px; max-height: 140px; overflow:auto; background: #fbfcff; }
    .orderLine{ font-size: 13px; padding: 6px 0; border-bottom:1px dashed #e6eaf2; }
    .orderLine:last-child{ border-bottom:none; }

    textarea{
      width:100%; height: 330px; border-radius: 12px; border: 1px solid var(--line); padding: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px; resize: vertical; background:#fff;
    }

    .btnRow{ display:flex; gap: 10px; }
    .btn{ flex:1; padding: 12px 12px; border: none; border-radius: 10px; cursor:pointer; font-weight: 900; font-size: 14px; user-select:none; }
    .copy-btn{ background: var(--blue); color:#fff; }
    .copy-btn:hover{ background: var(--blue2); }
    .whatsapp-btn{ background: var(--green); color:#fff; }
    .whatsapp-btn:hover{ background: var(--green2); }
    .clear-btn{ background:#f1f5f9; border:1px solid #e2e8f0; color:#334155; }
    .clear-btn:hover{ background:#e9eef6; }

    /* Modal */
  .modalOverlay{
  position: fixed;
  inset: 0;
  background: rgba(2,6,23,.55);
  display:none;
  align-items: center;
  justify-content: center;
  padding: 12px;
  z-index: 999;
  overflow: auto; /* si el modal es m√°s alto, que scrollee el overlay */
}

/* El modal NO debe scrollear en X, solo en Y dentro del body */
.modal{
  width: min(980px, 96vw);
  max-height: 95vh;
  background: var(--panel);
  border-radius: 18px;
  box-shadow: var(--shadow);
  border: 1px solid rgba(255,255,255,.25);
  overflow: hidden;      /* üî• corta el scroll horizontal del modal */
  display: flex;         /* üî• para separar header/body */
  flex-direction: column;
}

/* Si ten√©s un header del modal, esto evita que se ‚Äúpierda‚Äù */
.modalHeader{
  position: sticky;
  top: 0;
  background: var(--panel);
  z-index: 2;
}

/* El body es el que scrollea */
.modalBody{
  display: grid;
  grid-template-columns: 1.25fr 1fr;
  gap: 18px;
  padding: 16px;
  overflow-y: auto;      /* üî• scroll vertical */
  overflow-x: hidden;    /* üî• sin scroll horizontal */
  max-height: 95vh;      /* fallback */
  min-width: 0;          /* üî• evita overflow por grid */
}

.modalImg{
  border-radius: 14px;
  overflow: hidden;
  border: 1px solid var(--line);
  background: #eef2ff;
  height: 360px;
}

.modalImg img{
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

/* üì± MOBILE */
@media (max-width: 768px){
  .modal{
    width: 100%;
    max-height: 95vh;
    border-radius: 16px;
  }

  .modalBody{
    grid-template-columns: 1fr; /* una columna */
    max-height: 95vh;
  }

  .modalImg{
    height: 220px;
  }
}
/* ===== MOBILE ===== */
@media (max-width: 768px){
  .modal{
    width: 100%;
    max-height: 95vh;
    border-radius: 16px;
  }

  .modalBody{
    grid-template-columns: 1fr; /* una columna */
  }

  .modalImg{
    height: 220px; /* imagen m√°s chica */
  }
}

    .modalForm{ display:flex; flex-direction:column; gap: 12px; }
    .desc{ color: var(--muted); font-size: 13px; line-height:1.35; }

    .fieldLabel{ font-weight: 900; font-size: 14px; margin: 4px 0 6px 0; }
    .options{ display:flex; flex-wrap:wrap; gap: 10px; }

    .opt{
      border:1px solid var(--line); background:#f8fafc; padding: 10px 12px; border-radius: 12px;
      cursor:pointer; font-weight: 900; font-size: 13px; user-select:none; min-width: 92px; text-align:center;
    }
    .opt:hover{ border-color:#cfe0ff; background:#eef2ff; }
    .opt.selected{ background: linear-gradient(180deg, var(--blue), var(--blue2)); border-color: rgba(0,0,0,0); color:#fff; }

    .row{ display:flex; gap: 12px; align-items:flex-end; flex-wrap:wrap; }
    .row > div{ flex: 1; min-width: 180px; }

    select{
      width:100%; padding: 12px 12px; border-radius: 12px; border: 1px solid var(--line);
      font-size: 14px; outline:none; background:#fff;
    }
    .hint{ font-size: 12px; color: var(--muted); }

    .radioRow{ display:flex; gap: 10px; align-items:center; flex-wrap:wrap; }
    .radioCard{
      border: 1px solid var(--line); background:#f8fafc; padding: 10px 12px; border-radius: 12px;
      display:flex; align-items:center; gap: 10px; cursor:pointer; user-select:none; font-weight: 900;
    }
    .radioCard input{ transform: scale(1.1); }

    .modalFooter{
      padding: 14px 16px; border-top:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap: 12px; background:#fbfcff;
    }
    .modalFooter .minInfo{ color: var(--muted); font-size: 13px; }
    .addBtn{ background: var(--orange); color:#fff; border:none; padding: 12px 14px; border-radius: 12px; font-weight: 950; cursor:pointer; }
    .addBtn:hover{ filter: brightness(.95); }

    .toast{
      position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%);
      background: rgba(2,6,23,.85); color: #fff; padding: 10px 12px; border-radius: 999px;
      font-weight: 900; font-size: 13px; opacity:0; pointer-events:none;
      transition: opacity .18s ease, transform .18s ease; z-index: 1000;
    }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(-4px); }

    /* ================= MOBILE FIX ================= */

@media (max-width: 900px){

  .container{
    flex-direction: column;   /* üî• apila todo */
    height: auto;
  }

  .sidebar{
    width: 100%;
    border-right: none;
    border-bottom: 1px solid var(--line);
  }

  .main{
    width: 100%;
  }

  .order{
    width: 100%;              /* üî• que no tenga ancho fijo */
    border-left: none;
    border-top: 1px solid var(--line);
  }

}
  </style>
</head>

<body>
<header>Botonera Enri ¬∑ Cat√°logo(pedido por WhatsApp)</header>

<div class="container">
  <div class="sidebar">
    <h3>Categor√≠as</h3>
    <div class="category" id="cat-metalicos" onclick="loadCategory('metalicos')">Cierres met√°licos <small id="cnt-metalicos"></small></div>
    <div class="category" id="cat-plasticos" onclick="loadCategory('plasticos')">Cierres pl√°sticos <small id="cnt-plasticos"></small></div>
    <div class="category" id="cat-invisibles" onclick="loadCategory('invisibles')">Cierres invisibles <small id="cnt-invisibles"></small></div>
    <div class="category" id="cat-cursores" onclick="loadCategory('cursores')">Cursores <small id="cnt-cursores"></small></div>
    <div class="category" id="cat-botones" onclick="loadCategory('botones')">Botones <small id="cnt-botones"></small></div>
    <div class="category" id="cat-elasticos" onclick="loadCategory('elasticos')">El√°sticos / Cordones <small id="cnt-elasticos"></small></div>
    <div class="category" id="cat-cintas" onclick="loadCategory('cintas')">Cintas <small id="cnt-cintas"></small></div>
    <div class="category" id="cat-avios" onclick="loadCategory('avios')">Av√≠os y accesorios <small id="cnt-avios"></small></div>
  </div>

  <div class="main">
    <div class="mainTop">
      <h2 id="categoryTitle">Seleccion√° una categor√≠a</h2>
    </div>
    <div class="products" id="products"></div>
  </div>

  <div class="order">
    <div class="clientBlock">
      <div class="clientLabel">Nombre del cliente <span class="req">*</span></div>
      <div class="clientRow">
        <input id="clientName" type="text" placeholder="Ej: Juan P√©rez" />
      </div>
      <div class="hint">Obligatorio para enviar el pedido por WhatsApp.</div>
    </div>

    <h3>Pedido</h3>
    <div class="orderLines" id="orderList"></div>
    <textarea id="orderText" readonly></textarea>

    <div class="btnRow">
      <button class="btn copy-btn" onclick="copyText()">Copiar texto</button>
      <button class="btn whatsapp-btn" onclick="sendWhatsAppPropio()">Enviar por WhatsApp</button>
    </div>
    <button class="btn clear-btn" onclick="clearOrder()">Limpiar pedido</button>

    <div class="hint">WhatsApp destino: +54 11 5839-0513</div>
  </div>
</div>

<!-- Modal -->
<div class="modalOverlay" id="modalOverlay" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modalHeader">
      <div>
        <div class="code" id="mCode">C√≥digo: ‚Äî</div>
        <h3 class="title" id="mTitle">Producto</h3>
      </div>
      <button class="x" onclick="closeModal()" aria-label="Cerrar">√ó</button>
    </div>

    <div class="modalBody">
      <div>
        <div class="modalImg">
          <img id="mImg" alt="Foto del producto" src="" />
        </div>
      </div>

      <div class="modalForm">
        <div class="desc" id="mDesc"></div>

        <div id="qualityBlock">
          <div class="fieldLabel">Marca / Calidad <span class="req">*</span></div>
          <div class="options" id="mQualities"></div>
        </div>

        <div>
          <div class="fieldLabel">Color <span class="req">*</span></div>
          <div class="options" id="mColors"></div>
          <div class="hint" id="mColorHint"></div>
        </div>

        <div>
          <div class="fieldLabel">Medida <span class="req">*</span></div>
          <div class="options" id="mSizes"></div>
        </div>

        <div class="row">
          <div>
            <div class="fieldLabel" id="qtyLabel">Cantidad <span class="req">*</span></div>
            <select id="mQty"></select>
            <div class="hint" id="mQtyHint"></div>
          </div>

          <div id="plasticExtraBlock" style="display:none;">
            <div class="fieldLabel">Si no hay esa medida, ¬øpodemos enviar una m√°s larga? <span class="req">*</span></div>
            <div class="radioRow">
              <label class="radioCard" onclick="setPlasticAllowLonger('SI')">
                <input type="radio" name="allowLonger" id="allowLongerYes" />
                S√≠
              </label>
              <label class="radioCard" onclick="setPlasticAllowLonger('NO')">
                <input type="radio" name="allowLonger" id="allowLongerNo" />
                No
              </label>
            </div>
            <div class="hint">Obligatorio en cierres pl√°sticos.</div>
          </div>
        </div>
      </div>
    </div>

    <div class="modalFooter">
      <div class="minInfo" id="mMinInfo">Regla de cantidad: ‚Äî</div>
      <button class="addBtn" onclick="confirmAdd()">Agregar al pedido</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">Listo</div>

<script>
/* ===========================
   CONFIG
=========================== */
const MI_NUMERO = "5491158390513"; // sin +, sin espacios

const colorCodes = {
  negro: "900",
  marino: "540",
  blanco: "001",
  crudo: "202",
  verde: "530",
  beige: "710"
};

const categoryTitleMap = {
  metalicos: "CIERRES MET√ÅLICOS",
  plasticos: "CIERRES PL√ÅSTICOS",
  invisibles: "CIERRES INVISIBLES",
  cursores: "CURSORES",
  botones: "BOTONES",
  elasticos: "EL√ÅSTICOS / CORDONES",
  cintas: "CINTAS",
  avios: "AV√çOS Y ACCESORIOS"
};

const cierresCats = new Set(["metalicos","plasticos","invisibles","cursores"]);
const elasticosCats = new Set(["elasticos","cintas"]);
const milesCats = new Set(["botones","avios"]);

/* ===========================
   CAT√ÅLOGO (bases provisorias donde falten)
   - baseCode: para tu resumen sistema (producto.medida.color)
=========================== */
const catalog = {
  metalicos: [
    {
      code: "BE-001", baseCode: "AI",
      name: "Cierre acero inoxidable",
      desc: "Seleccion√° color, medida y cantidad para armar tu pedido.",
      image: "https://placehold.co/1200x800?text=Cierre%20acero%20inoxidable",
      unit: "unidades",
      qualities: [
        { name: "Sancris", colors: ["apto","azul","negro"], sizes: ["6","8","10","12","14","16","18"] },
        { name: "YKK Eco",  colors: ["azul","negro"],       sizes: ["6","8","10","12","14","16","18"] }
      ]
    },
    {
      code: "BE-002", baseCode: "AL5", // provisorio
      name: "Cierre aluminio cadena 5",
      desc: "Seleccion√° color, medida y cantidad para armar tu pedido.",
      image: "https://placehold.co/1200x800?text=Cierre%20aluminio%20cadena%205",
      unit: "unidades",
      qualities: [
        { name: "Sancris", colors: ["apto","azul","negro"], sizes: ["6","8","10","12","14","16","18"] }
      ]
    },
    {
      code: "BE-003", baseCode: "B45F",
      name: "Cierre bronce 4.5",
      desc: "Seleccion√° color, medida y cantidad para armar tu pedido.",
      image: "https://placehold.co/1200x800?text=Cierre%20bronce%204.5",
      unit: "unidades",
      qualities: [
        { name: "Mil8",        colors: ["apto","azul","beige","blanco","militar","negro"], sizes: ["6","8","10","12","14","16","18"] },
        { name: "Sancris",     colors: ["apto","azul","beige","blanco","militar","negro"], sizes: ["6","8","10","12","14","16","18"] },
        { name: "YKK Eco",     colors: ["azul","negro"],                                  sizes: ["6","8","10","12","14","16","18"] },
        { name: "YKK Premium", colors: ["apto","azul","beige","blanco","militar","negro"], sizes: ["6","8","10","12","14","16","18"] }
      ]
    },
    {
      code: "BE-004", baseCode: "MET5", // provisorio
      name: "Cierre en cadena reforzado cadena 5",
      desc: "Seleccion√° color, medida y cantidad para armar tu pedido.",
      image: "https://placehold.co/1200x800?text=Cierre%20en%20cadena%20reforzado%20cadena%205",
      unit: "unidades",
      qualities: [
        { name: "Sancris", colors: ["apto","azul","negro"], sizes: ["6","8","10","12","14","16","18"] }
      ]
    }
  ],

  plasticos: [
    {
      code: "BE-005", baseCode: "DPF",
      name: "Cierre diente de perro (fijo)",
      desc: "Seleccion√° color, medida y cantidad para armar tu pedido.",
      image: "https://placehold.co/1200x800?text=Cierre%20diente%20de%20perro%20(fijo)",
      unit: "unidades",
      qualities: [
        { name: "Sancris", colors: ["apto","azul","negro"], sizes: ["6","8","10","12","14","16","18"] }
      ]
    },
    {
      code: "BE-006", baseCode: "DPS",
      name: "Cierre diente de perro (separable)",
      desc: "Seleccion√° color, medida y cantidad para armar tu pedido.",
      image: "https://placehold.co/1200x800?text=Cierre%20diente%20de%20perro%20(separable)",
      unit: "unidades",
      qualities: [
        { name: "Sancris", colors: ["apto","azul","negro"], sizes: ["6","8","10","12","14","16","18"] }
      ]
    },
    {
      code: "BE-007", baseCode: "ENG3", // provisorio
      name: "Cierre engomado cadena 3",
      desc: "Seleccion√° color, medida y cantidad para armar tu pedido.",
      image: "https://placehold.co/1200x800?text=Cierre%20engomado%20cadena%203",
      unit: "unidades",
      qualities: [
        { name: "Sancris", colors: ["negro"], sizes: ["6","8","10","12","14","16","18"] }
      ]
    },
    {
      code: "BE-008", baseCode: "PL3", // provisorio
      name: "Cierre en cadena pl√°stico cadena 3",
      desc: "Seleccion√° color, medida y cantidad para armar tu pedido.",
      image: "https://placehold.co/1200x800?text=Cierre%20en%20cadena%20pl%C3%A1stico%20cadena%203",
      unit: "unidades",
      qualities: [
        { name: "Sancris", colors: ["apto","azul","negro"], sizes: ["6","8","10","12","14","16","18"] }
      ]
    },
    {
      code: "BE-009", baseCode: "PL2", // provisorio
      name: "Cierre pl√°stico cadena 2",
      desc: "Seleccion√° color, medida y cantidad para armar tu pedido.",
      image: "https://placehold.co/1200x800?text=Cierre%20pl%C3%A1stico%20cadena%202",
      unit: "unidades",
      qualities: [
        { name: "Sancris", colors: ["apto","azul","negro"], sizes: ["6","8","10","12","14","16","18"] }
      ]
    },
    {
      code: "BE-010", baseCode: "P15F", // asumimos reforzado fijo (si no, lo cambi√°s despu√©s)
      name: "Cierre pl√°stico reforzado cadena 5",
      desc: "Seleccion√° color, medida y cantidad para armar tu pedido.",
      image: "https://placehold.co/1200x800?text=Cierre%20pl%C3%A1stico%20reforzado%20cadena%205",
      unit: "unidades",
      qualities: [
        { name: "Sancris", colors: ["apto","azul","negro"], sizes: ["6","8","10","12","14","16","18"] }
      ]
    },
    {
      code: "BE-011", baseCode: "P15F",
      name: "Cierre pl√°stico reforzado cadena 5 (fijo)",
      desc: "Seleccion√° color, medida y cantidad para armar tu pedido.",
      image: "https://placehold.co/1200x800?text=Cierre%20pl%C3%A1stico%20reforzado%20cadena%205%20(fijo)",
      unit: "unidades",
      qualities: [
        { name: "Sancris", colors: ["apto","azul","negro"], sizes: ["6","8","10","12","14","16","18"] }
      ]
    },
    {
      code: "BE-012", baseCode: "P15S",
      name: "Cierre pl√°stico reforzado cadena 5 (separable)",
      desc: "Seleccion√° color, medida y cantidad para armar tu pedido.",
      image: "https://placehold.co/1200x800?text=Cierre%20pl%C3%A1stico%20reforzado%20cadena%205%20(separable)",
      unit: "unidades",
      qualities: [
        { name: "Sancris", colors: ["apto","azul","negro"], sizes: ["6","8","10","12","14","16","18"] }
      ]
    },
    {
      code: "BE-013", baseCode: "REV5", // provisorio
      name: "Cierre reverso cadena 5",
      desc: "Seleccion√° color, medida y cantidad para armar tu pedido.",
      image: "https://placehold.co/1200x800?text=Cierre%20reverso%20cadena%205",
      unit: "unidades",
      qualities: [
        { name: "Sancris", colors: ["apto","azul","negro"], sizes: ["6","8","10","12","14","16","18"] }
      ]
    },
    {
      code: "BE-014", baseCode: "SIL5", // provisorio
      name: "Cierre silver cadena 5 pl√°stico plateado",
      desc: "Seleccion√° color, medida y cantidad para armar tu pedido.",
      image: "https://placehold.co/1200x800?text=Cierre%20silver%20cadena%205%20pl%C3%A1stico%20plateado",
      unit: "unidades",
      qualities: [
        { name: "Sancris", colors: ["apto","azul","negro"], sizes: ["6","8","10","12","14","16","18"] }
      ]
    }
  ],

  invisibles: [
    {
      code: "BE-015", baseCode: "INV3", // provisorio
      name: "Cierre invisible cadena 3 fijo",
      desc: "Seleccion√° color, medida y cantidad para armar tu pedido.",
      image: "https://placehold.co/1200x800?text=Cierre%20invisible%20cadena%203%20fijo",
      unit: "unidades",
      qualities: [
        { name: "Sancris", colors: ["apto","azul","beige","blanco","negro"], sizes: ["10","12","14","16","18","20","22","24"] }
      ]
    }
  ],

  cursores: [
    {
      code: "BE-016", baseCode: "CUR", // provisorio
      name: "Cursores cadena 5 y 3",
      desc: "Seleccion√° color, medida y cantidad para armar tu pedido.",
      image: "https://placehold.co/1200x800?text=Cursores%20cadena%205%20y%203",
      unit: "unidades",
      qualities: [
        { name: "Sancris", colors: ["apto","azul","negro"], sizes: ["3","5"] }
      ]
    }
  ],

  botones: [
    {
      code: "BE-017", baseCode: "BTN1001", // provisorio
      name: "Bot√≥n acr√≠lico 1001 (4 y 2 agujeros)",
      desc: "Seleccion√° color, medida y cantidad para armar tu pedido.",
      image: "https://placehold.co/1200x800?text=Bot%C3%B3n%20acr%C3%ADlico%201001",
      unit: "unidades",
      qualities: [
        { name: "Standard", colors: ["azul","beige","blanco","marr√≥n","negro"], sizes: ["18","20","22","24"] }
      ]
    },
    {
      code: "BE-018", baseCode: "BTN93",
      name: "Bot√≥n bicapa 93",
      desc: "Seleccion√° color, medida y cantidad para armar tu pedido.",
      image: "https://placehold.co/1200x800?text=Bot%C3%B3n%20bicapa%2093",
      unit: "unidades",
      qualities: [
        { name: "Standard", colors: ["azul","beige","blanco","negro"], sizes: ["18","20","22","24"] }
      ]
    }
  ],

  elasticos: [
    {
      code: "BE-027", baseCode: "ELA", // provisorio
      name: "Cord√≥n el√°stico",
      desc: "Venta por rollo: m√∫ltiplos de 50 metros.",
      image: "https://placehold.co/1200x800?text=Cord%C3%B3n%20el%C3%A1stico",
      unit: "metros",
      qualities: [
        { name: "Standard", colors: ["blanco","negro"], sizes: ["3","4","5"] }
      ]
    }
  ],

  cintas: [
    {
      code: "BE-042", baseCode: "CINBIES", // provisorio
      name: "Cinta bies",
      desc: "Venta por rollo: m√∫ltiplos de 50 metros.",
      image: "https://placehold.co/1200x800?text=Cinta%20bies",
      unit: "metros",
      qualities: [
        { name: "Standard", colors: ["blanco","negro"], sizes: ["20","25"] }
      ]
    }
  ],

  avios: [
    {
      code: "BE-033", baseCode: "AVI", // provisorio
      name: "Broche",
      desc: "Venta por bolsa: m√∫ltiplos de 1000 unidades.",
      image: "https://placehold.co/1200x800?text=Broche",
      unit: "unidades",
      qualities: [
        { name: "Standard", colors: ["negro","niquel"], sizes: ["10","12","15"] }
      ]
    }
  ]
};

/* ===========================
   STATE
=========================== */
let currentCategory = null;
let orderItems = []; // array of objects
let modalProduct = null;
let selectedQuality = null;
let selectedColor = null;
let selectedSize = null;
let plasticAllowLonger = null; // "SI" | "NO" | null

/* ===========================
   HELPERS
=========================== */
const $ = (id) => document.getElementById(id);

function toast(msg){
  const t = $("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=> t.classList.remove("show"), 1300);
}

function normalizeColorKey(c){
  return String(c || "").trim().toLowerCase();
}

function getColorCode(colorName){
  const key = normalizeColorKey(colorName);
  return colorCodes[key] || "999"; // provisorio si no est√° mapeado
}

function normalizeMeasure(m){
  // para c√≥digo interno: sacamos espacios, dejamos letras/n√∫meros
  return String(m || "").trim().replace(/\s+/g,"").replace(/[^a-zA-Z0-9]/g,"");
}

function buildInternalCode(product, measure, colorName){
  const base = product.baseCode || product.code || "XXX";
  const med = normalizeMeasure(measure) || "0";
  const col = getColorCode(colorName);
  return `${base}.${med}.${col}`;
}

function isPlasticCategory(cat){
  return cat === "plasticos";
}

function qtyOptionsForCategory(cat){
  // devuelve array de n√∫meros
  if (cierresCats.has(cat)) {
    const arr = [];
    for(let q=50; q<=1000; q+=50) arr.push(q);
    for(let q=1100; q<=5000; q+=100) arr.push(q);
    return { options: arr, hint: "Cierres: 50‚Üí1000 (de 50), 1100‚Üí5000 (de 100)." };
  }
  if (elasticosCats.has(cat)) {
    const arr = [];
    for(let q=50; q<=5000; q+=50) arr.push(q);
    return { options: arr, hint: "Rollo: m√∫ltiplos de 50 (hasta 5000)." };
  }
  if (milesCats.has(cat)) {
    const arr = [];
    for(let q=1000; q<=10000; q+=1000) arr.push(q);
    return { options: arr, hint: "Bolsas: m√∫ltiplos de 1000 (hasta 10000)." };
  }
  // fallback
  return { options: [1,2,3,4,5,10,20,50,100], hint: "Cantidad libre (provisorio)." };
}

function setCounts(){
  const keys = ["metalicos","plasticos","invisibles","cursores","botones","elasticos","cintas","avios"];
  keys.forEach(k=>{
    const el = $("cnt-"+k);
    if(!el) return;
    const n = (catalog[k] || []).length;
    el.textContent = n ? String(n) : "";
  });
}

function setActiveCat(cat){
  ["metalicos","plasticos","invisibles","cursores","botones","elasticos","cintas","avios"].forEach(c=>{
    const el = $("cat-"+c);
    if(!el) return;
    el.classList.toggle("active", c===cat);
  });
}

/* ===========================
   RENDER PRODUCTS
=========================== */
function loadCategory(cat){
  currentCategory = cat;
  setActiveCat(cat);

  $("categoryTitle").innerText = categoryTitleMap[cat] || cat.toUpperCase();
  const container = $("products");
  container.innerHTML = "";

  (catalog[cat] || []).forEach((p, i) => {
    const colorsSet = new Set();
    const sizesSet = new Set();
    (p.qualities || []).forEach(q=>{
      (q.colors || []).forEach(c=>colorsSet.add(c));
      (q.sizes || []).forEach(s=>sizesSet.add(s));
    });
    const colorsCount = colorsSet.size;
    const sizesCount = sizesSet.size;
    const qualitiesCount = (p.qualities || []).length;

    container.innerHTML += `
      <div class="product" onclick="openProduct('${cat}', ${i})">
        <div class="pImg">
          <img src="${p.image}" alt="${p.name}">
          <div class="pBadge">${p.code || ""}</div>
        </div>
        <div class="pBody">
          <div class="pTitle">${p.name}</div>
          <div class="pSub">${p.desc || ""}</div>
          <div class="pFoot">
            <span class="pill">${p.unit === "metros" ? "Rollo" : "Paquete"} ¬∑ ver cantidades</span>
            <span>${colorsCount} colores ¬∑ ${sizesCount} medidas ¬∑ ${qualitiesCount} cal.</span>
          </div>
        </div>
      </div>
    `;
  });
}

/* ===========================
   MODAL
=========================== */
function openProduct(cat, index){
  modalProduct = (catalog[cat] || [])[index];
  selectedQuality = null;
  selectedColor = null;
  selectedSize  = null;
  plasticAllowLonger = null;

  $("mCode").innerText = "C√≥digo: " + (modalProduct.code || "‚Äî");
  $("mTitle").innerText = modalProduct.name || "Producto";
  $("mDesc").innerText = modalProduct.desc || "";
  $("mImg").src = modalProduct.image || "";
  $("mImg").alt = modalProduct.name || "Producto";

  // quality
  const qWrap = $("mQualities");
  qWrap.innerHTML = "";
  const qualities = modalProduct.qualities || [];
  if(qualities.length <= 1){
    $("qualityBlock").style.display = "none";
    selectedQuality = qualities[0]?.name || "Standard";
  } else {
    $("qualityBlock").style.display = "block";
    qualities.forEach(q=>{
      const btn = document.createElement("div");
      btn.className = "opt";
      btn.textContent = q.name;
      btn.onclick = ()=> selectQuality(btn, q.name);
      qWrap.appendChild(btn);
    });
  }

  // plastic mandatory question
  const isPlastic = isPlasticCategory(cat);
  $("plasticExtraBlock").style.display = isPlastic ? "block" : "none";
  $("allowLongerYes").checked = false;
  $("allowLongerNo").checked = false;

  // quantity options
  const qData = qtyOptionsForCategory(cat);
  const sel = $("mQty");
  sel.innerHTML = "";
  qData.options.forEach(v=>{
    const opt = document.createElement("option");
    opt.value = String(v);
    opt.textContent = String(v);
    sel.appendChild(opt);
  });

  // labels by unit
  const unit = modalProduct.unit || "unidades";
  $("qtyLabel").innerHTML = `Cantidad (${unit}) <span class="req">*</span>`;
  $("mQtyHint").innerText = qData.hint;
  $("mMinInfo").innerText = `Regla de cantidad: ${qData.hint}`;

  rebuildColorSizeOptions();
  $("modalOverlay").style.display = "flex";
}

function rebuildColorSizeOptions(){
  const qualities = modalProduct.qualities || [];
  let q = qualities[0] || null;
  if(selectedQuality){
    q = qualities.find(x=>x.name===selectedQuality) || q;
  }

  const colors = q?.colors || [];
  const sizes  = q?.sizes  || [];

  const colorsWrap = $("mColors");
  colorsWrap.innerHTML = "";
  colors.forEach(c=>{
    const btn = document.createElement("div");
    btn.className = "opt";
    btn.textContent = c;
    btn.onclick = ()=> selectColor(btn, c);
    colorsWrap.appendChild(btn);
  });

  const sizesWrap = $("mSizes");
  sizesWrap.innerHTML = "";
  sizes.forEach(s=>{
    const btn = document.createElement("div");
    btn.className = "opt";
    btn.textContent = s;
    btn.onclick = ()=> selectSize(btn, s);
    sizesWrap.appendChild(btn);
  });

  selectedColor = null;
  selectedSize = null;

  $("mColorHint").innerText = "Si un color no tiene c√≥digo a√∫n, se usa 999 (provisorio).";
}

function selectQuality(btn, value){
  selectedQuality = value;
  [...$("mQualities").children].forEach(x=> x.classList.remove("selected"));
  btn.classList.add("selected");
  rebuildColorSizeOptions();
}
function selectColor(btn, value){
  selectedColor = value;
  [...$("mColors").children].forEach(x=> x.classList.remove("selected"));
  btn.classList.add("selected");
}
function selectSize(btn, value){
  selectedSize = value;
  [...$("mSizes").children].forEach(x=> x.classList.remove("selected"));
  btn.classList.add("selected");
}

function setPlasticAllowLonger(value){
  plasticAllowLonger = value;
  if(value === "SI"){
    $("allowLongerYes").checked = true;
    $("allowLongerNo").checked = false;
  } else {
    $("allowLongerYes").checked = false;
    $("allowLongerNo").checked = true;
  }
}

function closeModal(){ $("modalOverlay").style.display = "none"; }

$("modalOverlay").addEventListener("click", (e)=>{
  if(e.target.id === "modalOverlay") closeModal();
});
window.addEventListener("keydown", (e)=>{
  if(e.key === "Escape") closeModal();
});

function confirmAdd(){
  if(!modalProduct) return;

  const cat = currentCategory;
  const qualities = modalProduct.qualities || [];

  if(qualities.length > 1 && !selectedQuality){ toast("Eleg√≠ una calidad"); return; }
  if(!selectedColor){ toast("Eleg√≠ un color"); return; }
  if(!selectedSize){ toast("Eleg√≠ una medida"); return; }

  if(isPlasticCategory(cat) && !plasticAllowLonger){
    toast("En cierres pl√°sticos: eleg√≠ SI o NO (medida m√°s larga)");
    return;
  }

  const qty = Number($("mQty").value);
  if(!Number.isFinite(qty) || qty <= 0){ toast("Cantidad inv√°lida"); return; }

  const unit = modalProduct.unit || "unidades";
  const qName = (qualities.length <= 1) ? (qualities[0]?.name || "Standard") : selectedQuality;
  const internalCode = buildInternalCode(modalProduct, selectedSize, selectedColor);

  orderItems.push({
    category: cat,
    productCode: modalProduct.code || "",
    baseCode: modalProduct.baseCode || "",
    name: modalProduct.name,
    quality: qName,
    color: selectedColor,
    colorCode: getColorCode(selectedColor),
    size: selectedSize,
    qty: qty,
    unit: unit,
    allowLonger: isPlasticCategory(cat) ? plasticAllowLonger : null,
    internalCode: internalCode
  });

  updateOrder();
  closeModal();
  toast("Agregado al pedido");
}

/* ===========================
   ORDER TEXT (2 SECCIONES)
=========================== */
function updateOrder(){
  const list = $("orderList");
  list.innerHTML = "";

  if(orderItems.length === 0){
    list.innerHTML = `<div style="color:#64748b;font-size:13px;">Todav√≠a no agregaste productos.</div>`;
    $("orderText").value = `PEDIDO MAYORISTA\n\nCliente: (completar)\n\n--------------------------------\n\n(Agregar √≠tems desde el cat√°logo)\n\n================================\nRESUMEN PARA SISTEMA\n\n`;
    return;
  }

  orderItems.forEach((it, idx)=>{
    const div = document.createElement("div");
    div.className = "orderLine";
    div.textContent = `${it.internalCode} x${it.qty}`;
    list.appendChild(div);
  });

  $("orderText").value = buildOrderText();
}

function buildOrderText(){
  const client = ($("clientName").value || "").trim();

  let text = `PEDIDO MAYORISTA\n\nCliente: ${client || "(completar)"}\n\n--------------------------------\n\n`;

  // Detalle
  orderItems.forEach(it=>{
    text += `${it.internalCode}\n`;
    text += `${it.productCode} | ${it.name}\n`;
    text += `Calidad: ${it.quality}\n`;
    text += `Color: ${it.color} (c√≥d ${it.colorCode})\n`;
    text += `Medida: ${it.size}\n`;
    text += `Cantidad: ${it.qty} ${it.unit}\n`;
    if(it.category === "plasticos"){
      text += `Acepta medida m√°s larga: ${it.allowLonger}\n`;
    }
    text += `\n`;
  });

  // Resumen sistema (agrupado)
  const agg = new Map(); // internalCode -> qty sum
  orderItems.forEach(it=>{
    agg.set(it.internalCode, (agg.get(it.internalCode) || 0) + Number(it.qty));
  });

  text += `================================\nRESUMEN PARA SISTEMA\n\n`;
  for(const [code, qty] of agg.entries()){
    text += `${code} x${qty}\n`;
  }
  return text;
}

$("clientName").addEventListener("input", ()=>{
  // Actualiza el texto para que el cliente quede reflejado
  $("orderText").value = buildOrderText();
});

function copyText(){
  const text = $("orderText");
  text.focus();
  text.select();
  document.execCommand("copy");
  toast("Texto copiado");
}

function clearOrder(){
  orderItems = [];
  updateOrder();
  toast("Pedido limpiado");
}

function sendWhatsAppPropio(){
  const client = ($("clientName").value || "").trim();
  if(!client){
    toast("Falta el nombre del cliente");
    $("clientName").focus();
    return;
  }
  if(orderItems.length === 0){
    toast("El pedido est√° vac√≠o");
    return;
  }
  const msg = encodeURIComponent(buildOrderText());
  window.open(`https://wa.me/${MI_NUMERO}?text=${msg}`, "_blank");
}

/* ===========================
   INIT
=========================== */
setCounts();
updateOrder();
loadCategory("metalicos");
</script>

</body>
</html>
